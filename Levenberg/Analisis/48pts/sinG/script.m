%function script()
%Puntos seleccionados en pixeles
%imgPts y scnPts están en el orden original

imgPts = [837.8741455078125, 897.2778930664062, 956.9844360351562, 1016.42333984375, 1076.3017578125, 1136.21044921875, 832.9345092773438, 895.29541015625, 957.1570434570312, 1019.464172363281, 1081.859375, 1144.757080078125, 827.8035278320312, 892.4791870117188, 957.6625366210938, 1022.542297363281, 1087.906127929688, 1153.239379882812, 821.8426513671875, 890.1197509765625, 957.7943115234375, 1026.245727539062, 1094.3779296875, 1163.309936523438, 815.56787109375, 886.8239135742188, 958.4537963867188, 1029.955322265625, 1101.938354492188, 1174.005615234375, 808.3628540039062, 883.7537841796875, 958.714111328125, 1034.350463867188, 1109.638305664062, 1185.86376953125, 800.7138061523438, 879.9265747070312, 959.5117797851562, 1038.83056640625, 1118.88916015625, 1198.915893554688, 791.6714477539062, 875.909912109375, 959.8040771484375, 1044.343017578125, 1128.69677734375, 1214.092529296875;
  679.0939331054688, 676.92724609375, 674.5238647460938, 672.1847534179688, 670.0202026367188, 667.4046630859375, 703.5702514648438, 701.4966430664062, 699.173828125, 696.7796020507812, 694.4873657226562, 692.2327270507812, 729.8762817382812, 726.9873046875, 724.7837524414062, 722.2488403320312, 719.9083862304688, 717.5863647460938, 758.3207397460938, 754.8271484375, 752.7904052734375, 750.1862182617188, 747.7540283203125, 745.3524169921875, 789.2471313476562, 786.6021728515625, 783.5311279296875, 781.093505859375, 778.31787109375, 776.1768798828125, 824.7357177734375, 821.5552368164062, 818.5955810546875, 816.066162109375, 813.6526489257812, 811.060791015625, 864.3524169921875, 861.1209106445312, 858.2491455078125, 855.4376220703125, 853.0947265625, 850.376708984375, 908.6774291992188, 905.4671020507812, 902.0062255859375, 899.7337036132812, 896.8604736328125, 894.7748413085938;
  1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1];
scnPts = [0, 0.119999997317791, 0.239999994635582, 0.3599999845027924, 0.4799999892711639, 0.5999999642372131, 0, 0.119999997317791, 0.239999994635582, 0.3599999845027924, 0.4799999892711639, 0.5999999642372131, 0, 0.119999997317791, 0.239999994635582, 0.3599999845027924, 0.4799999892711639, 0.5999999642372131, 0, 0.119999997317791, 0.239999994635582, 0.3599999845027924, 0.4799999892711639, 0.5999999642372131, 0, 0.119999997317791, 0.239999994635582, 0.3599999845027924, 0.4799999892711639, 0.5999999642372131, 0, 0.119999997317791, 0.239999994635582, 0.3599999845027924, 0.4799999892711639, 0.5999999642372131, 0, 0.119999997317791, 0.239999994635582, 0.3599999845027924, 0.4799999892711639, 0.5999999642372131, 0, 0.119999997317791, 0.239999994635582, 0.3599999845027924, 0.4799999892711639, 0.5999999642372131;
  0, 0, 0, 0, 0, 0, 0.119999997317791, 0.119999997317791, 0.119999997317791, 0.119999997317791, 0.119999997317791, 0.119999997317791, 0.239999994635582, 0.239999994635582, 0.239999994635582, 0.239999994635582, 0.239999994635582, 0.239999994635582, 0.3599999845027924, 0.3599999845027924, 0.3599999845027924, 0.3599999845027924, 0.3599999845027924, 0.3599999845027924, 0.4799999892711639, 0.4799999892711639, 0.4799999892711639, 0.4799999892711639, 0.4799999892711639, 0.4799999892711639, 0.5999999642372131, 0.5999999642372131, 0.5999999642372131, 0.5999999642372131, 0.5999999642372131, 0.5999999642372131, 0.7199999690055847, 0.7199999690055847, 0.7199999690055847, 0.7199999690055847, 0.7199999690055847, 0.7199999690055847, 0.8399999737739563, 0.8399999737739563, 0.8399999737739563, 0.8399999737739563, 0.8399999737739563, 0.8399999737739563;
  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0;
  1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1];

K = [616.1640014648438, 0, 325.5280151367188;
  0, 616.8200073242188, 228.6600036621094;
  0, 0, 1];
  Kinv=inv(K);
  %se pasa a m
  imgPtsm=Kinv*imgPts;
  %La homografía es de scp a imp


  imp=[imgPts(1:2,:)];
  scp=[scnPts(1:2,:)];
  scp2=[scp;ones(1, size(imgPts,2)
)];

H=[0.7944980996608, -0.3552882991900599, 0.831954809746873;
  -0.03695065223268957, 0.05424549834400218, 0.7304964605198651;
  -0.008574659915334355, -0.3505543060177539, 1];
  mapeoIm=H*scp2;
  %mapeoIm2
  %Deshomog...
  for i=1: size(mapeoIm,2)
    mapeoIm(:,i)=mapeoIm(1:3,i)/mapeoIm(3,i);
  end
%Distancia entre los 2 conjuntos de puntos
temp=mapeoIm;
dist1=[];
  for i=1: size(mapeoIm,2)
    temp(1:3,i)=(mapeoIm(1:3,i)-imgPtsm(1:3,i));
    dist1(i)=norm(temp(:,i));
  end

Dummy = [1, 0, 0, 0;
  0, 1, 0, 0;
  0, 0, 1, 0];

%sin Gram.. sin optimizar
  #{
R= [0.9988622003599396, -0.7076660498009775, 0.03360154050952557;
  -0.04645525245389113, 0.1080466134688273, 0.7050712218227977;
  -0.01078026954882046, -0.6982368446859548, 0.07504887307436045];
T= [1.2824365525311;
  1.126041164123203;
  1.541473812647695];
  #}
%optimizado
R=[0.6233078700228907, -0.669335287236308, 0.3231482444623395;
  -0.469711761304958, -0.05245065158759399, 0.8614811589481631;
  -0.5760254993753289, -0.7174741801564467, -0.3607940624730153];
T=[1.415553283405051;
  1.235958192557387;
  1.687760179486518];
  %optimizado con la d calculada a partir del punto 48, no funciona
  #{
R=[-2.340666327427243e-08, 4.349805920224576e-15, 2.507520103940949e-13;
  -4.349805921157429e-15, -2.340666327427243e-08, 1.860110296367754e-12;
  -2.507520103940788e-13, -1.860110296367757e-12, -2.340666327427243e-08];
T=[-7.841946372178098e-15;
  -1.63574210264411e-15;
  2.650527848523358e-13];
  #}


G= [[R T]; [0, 0, 0, 1]];
  
  %Rotamos y trasladamos los puntos establecidos y proyectamos en la image
  scnPtsRot=K*Dummy*G*scnPts;
  %Calculamos el error
  temp2=scnPtsRot;
  dist2=[];
  for i=1: size(imgPts,2)
    %temp2(1:4,i)=(intersec(1:4,i)-scnPtsRot(1:4,i));
    temp2(1:3,i)=scnPtsRot(1:3,i)/scnPtsRot(3,i);
    %dist2(i)=norm(temp2(:,i));
  end
  %temp2=[temp2(1:3,:)];
  temp3=temp2;
  errorPix=temp3;
  for i=1:size(temp3,2)
    errorPix(1:3,i)=(imgPts(1:3,i)-temp3(1:3,i));
  end

  %Error en metros
  scnPtsRotm=R*scnPts(1:3,:)+T;
scnPtsRotm2=scnPtsRotm;
%scnPtsRotm=[scnPtsRotm(1:3,:)];
%Deshomoge...
  #{
  for i=1: size(scnPtsRotm,2)
    scnPtsRotm(1:3,i)=scnPtsRotm(1:3,i)/scnPtsRotm(3,i);
  end

  errorM=scnPtsRotm;
  for i=1:size(errorM,2)
    errorM(1:3,i)=(imgPtsm(1:3,i)-scnPtsRotm(1:3,i));
  end
  #}

  %Interseccion plano-recta
Column=scnPts(1:3,1);
scPt=R*Column+T;
N=R(:,3);
D=dot(N,scPt);
%Pasamos a m los pts de la imagen, y se normalizan

imgNorm=imgPtsm;
  for i=1: size(imgPtsm,2)
    imgNorm(:,i)=imgPtsm(:,i)/norm(imgPtsm(:,i));
  end

  vPoints3d=imgNorm;
  %Calculamos la intersección de los pts con el plano
  for i=1: size(imgPtsm,2)
      pTemp=imgPtsm(:,i);
      rTemp=D/dot(N,pTemp);
      vPoints3d(:,i)=pTemp*rTemp;
  end
errorM=vPoints3d-scnPtsRotm;
normaError=[];
for i=1: size(imgPtsm, 2)
  normaError(i)=norm(errorM(:,i));
end
%end
